name: Poll for Container URL

on:
  schedule:
    - cron: "*/10 * * * *" # Every 10 minutes
  repository_dispatch:
    types: [poll-container-url]
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Extract inputs from the event payload (graceful skip if empty)
      - name: Extract inputs
        id: inputs
        run: |
          PR_NUMBER="${{ github.event.client_payload.pr_number || '' }}"
          CONTAINER_ID="${{ github.event.client_payload.container_id || '' }}"
          if [ -z "$PR_NUMBER" ] || [ -z "$CONTAINER_ID" ]; then
            echo "ℹ️ No PR number or container ID found (probably scheduled run). Skipping workflow..."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT

      # 3️⃣ Check if container already posted using GitHub Script
      - name: Check if container already posted
        if: steps.inputs.outputs.skip != 'true'
        id: skip
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr_number = parseInt("${{ steps.inputs.outputs.pr_number }}");
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
            });
            const exists = labels.data.some(l => l.name === "container-posted");
            return exists

      # 4️⃣ Stop workflow if already processed
      - name: Stop workflow if already processed
        if: steps.inputs.outputs.skip != 'true' && steps.skip.outputs.result == 'true'
        run: |
          echo "✅ Container URL already posted for PR #${{ steps.inputs.outputs.pr_number }}. Exiting..."
          exit 0

      # 5️⃣ Run your container check script
      - name: Run check script
        if: steps.inputs.outputs.skip != 'true'
        id: check
        run: |
          chmod +x scripts/check_url.sh
          URL=$(./scripts/check_url.sh "${{ steps.inputs.outputs.container_id }}" | tail -n 1 || true)
          echo "container_url=$URL" >> $GITHUB_OUTPUT
          echo "Final container URL: $URL"

      # 6️⃣ Stop if URL not ready yet
      - name: Stop if URL not ready
        if: steps.inputs.outputs.skip != 'true' && steps.check.outputs.container_url == ''
        run: |
          echo "❌ URL not ready yet, will retry in 10 minutes."
          exit 0

      # 7️⃣ Post container URL as PR comment
      - name: Post result back to PR
        if: steps.inputs.outputs.skip != 'true' && steps.check.outputs.container_url != ''
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ steps.inputs.outputs.pr_number }}
          body: |
            Container ID: `${{ steps.inputs.outputs.container_id }}`
            URL: ${{ steps.check.outputs.container_url }}

      # 8️⃣ Add label to mark PR as processed
      - name: Add 'container-posted' label
        if: steps.inputs.outputs.skip != 'true' && steps.check.outputs.container_url != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.PAT_TOKEN }}
          labels: container-posted
          number: ${{ steps.inputs.outputs.pr_number }}
          repo: ${{ github.repository }}
