name: Poll for URL

on:
  workflow_dispatch:      # Manual trigger for testing
  schedule:
    - cron: "*/10 * * * *"  # Runs every 10 minutes

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Read container ID
        id: read
        run: |
          if [ ! -f container_id.txt ]; then
            echo "container_id.txt not found!"
            exit 1
          fi
          CONTAINER_ID=$(cat container_id.txt)
          echo "Container ID: $CONTAINER_ID"
          echo "id=$CONTAINER_ID" >> $GITHUB_OUTPUT

      - name: Poll URL and process
        id: poll
        run: |
          CONTAINER_ID="${{ steps.read.outputs.id }}"
          URL="https://example.com/container/$CONTAINER_ID/data"
          echo "Checking URL: $URL"

          # Simulate readiness check (25% chance ready for demo)
          if [ $((RANDOM % 4)) -eq 0 ]; then
            echo "URL is ready! Fetching data..."
            RESPONSE=$(curl -s "$URL")
            echo "$RESPONSE" > response.json
            echo "Response saved to response.json"

            # Authenticate with PAT and upload artifact or release
            echo "${{ secrets.PAT_TOKEN }}" | gh auth login --with-token
            gh release create "container-$CONTAINER_ID" response.json || echo "Release already exists"
          else
            echo "URL not ready yet. Will check again in next run."
