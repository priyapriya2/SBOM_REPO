name: Poll for Container URL

on:
  schedule:
    - cron: "*/10 * * * *"  # Every 10 minutes
  repository_dispatch:
    types: [poll-container-url]
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract inputs
        id: inputs
        run: |
          echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
          echo "container_id=${{ github.event.client_payload.container_id }}" >> $GITHUB_OUTPUT

      - name: Run check script
        id: check
        run: |
          chmod +x scripts/check_url.sh
          URL=$(./scripts/check_url.sh "${{ steps.inputs.outputs.container_id }}" | tail -n 1 || true)
          echo "container_url=$URL" >> $GITHUB_OUTPUT
          echo "Final container URL: $URL"

      - name: Stop if URL not ready
        if: steps.check.outputs.container_url == ''
        run: |
          echo "❌ URL not ready yet, will retry in 10 minutes."
          exit 0

      - name: Post result back to PR
        if: steps.check.outputs.container_url != ''
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.inputs.outputs.pr_number }}
          body: |
            ✅ Container ID: `${{ steps.inputs.outputs.container_id }}`
            📦 URL: ${{ steps.check.outputs.container_url }}
